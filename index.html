<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cards Archives</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: rgb(0, 128, 255);
            color: white;
        }

        .btn-primary:hover {
            background-color: rgb(0, 100, 200);
        }

        .btn-secondary {
            background-color: #374151;
            color: white;
            border: 1px solid #4B5563;
        }

        .btn-secondary:hover {
            background-color: #4B5563;
        }

        .btn-danger {
            background-color: #DC2626;
            color: white;
        }

        .btn-danger:hover {
            background-color: #B91C1C;
        }

        .input {
            width: 100%;
            padding: 1rem;
            background-color: #1F2937;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
        }

        .input:focus {
            outline: none;
            border-color: rgb(0, 128, 255);
        }

        .title {
            color: rgb(0, 128, 255);
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .card {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            color: rgb(0, 128, 255);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .card-info {
            color: #9CA3AF;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1F2937;
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .price-entry {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .price-entry input {
            flex: 1;
            padding: 0.5rem;
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 0.25rem;
            color: white;
        }

        .icon-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-8 {
            margin-top: 2rem;
        }

        .text-center {
            text-align: center;
        }

        .menu-card {
            padding: 2rem;
            border: 2px solid #4B5563;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .menu-card:hover {
            border-color: rgb(0, 128, 255);
        }

        .chart-container {
            width: 100%;
            height: 100px;
            margin: 1rem 0;
        }

        .export-text {
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            padding: 1rem;
            color: white;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div style="max-width: 400px; margin: 5rem auto;">
                <h1 class="title">Cards Archives</h1>
                
                <div id="loginForm">
                    <div class="form-group">
                        <input type="text" id="loginAccountName" placeholder="Account Name" class="input">
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPin" placeholder="6-digit PIN" maxlength="6" class="input">
                    </div>
                    <div class="form-group">
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">Login</button>
                    </div>
					<div class="form-group" style="display: flex; gap: 0.5rem;">
						<input type="password" id="insiderPin" placeholder="8-digit PIN" maxlength="8" class="input" 
						style="flex: 2;">
						<button onclick="checkInsiderAccess()" class="btn btn-warning" style="flex: 1;">Insider</button>
					</div>
                    <div class="form-group">
                        <button onclick="showCreateForm()" class="btn btn-secondary" style="width: 100%;">Create New Account</button>
                    </div>
                    
                    <div class="mt-8">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Import Data:</label>
                        <input type="file" id="importFile" accept=".json" onchange="importData()" class="input">
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <button onclick="window.location.href='https://cardsarchives.github.io/Cards-Archives/privacy.html'" 
                        class="btn btn-secondary" style="width: 100%;">
                        üîí Privacy Policy</button>
                    </div>


                </div>

                <div id="createForm" class="hidden">
                    <h2 style="text-align: center; margin-bottom: 2rem;">Create Account</h2>
                    <div class="form-group">
                        <input type="text" id="createAccountName" placeholder="Account Name" class="input">
                    </div>
                    <div class="form-group">
                        <input type="password" id="createPin" placeholder="6-digit PIN" maxlength="6" class="input">
                    </div>
                    <div class="form-group">
                        <button onclick="createAccount()" class="btn btn-primary" style="width: 100%;">Create Account</button>
                    </div>
                    <div class="form-group">
                        <button onclick="hideCreateForm()" class="btn btn-secondary" style="width: 100%;">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Screen -->
        <div id="menuScreen" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 class="title" style="margin: 0;">Cards Archives</h1>
                <div class="flex gap-4">
                    <button onclick="showSettings()" class="icon-btn btn-secondary">‚öôÔ∏è</button>
                    <button onclick="logout()" class="icon-btn btn-danger">Logout</button>
                </div>
            </div>
            
            <div class="text-center mb-8">
                <p style="font-size: 1.2rem;">Welcome, <span id="currentUserName"></span>!</p>
            </div>
            
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div class="menu-card" onclick="showShowcase()">
                    <h2 style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1rem;">Showcase</h2>
                    <p style="color: #9CA3AF;">View and manage your card collection</p>
                </div>
                
                <div class="menu-card" onclick="showHuntlist()">
                    <h2 style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1rem;">Hunt List</h2>
                    <p style="color: #9CA3AF;">Track cards you want to acquire</p>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 style="color: rgb(0, 128, 255); font-size: 2rem; font-weight: bold;">Settings</h1>
                <button onclick="showMenu()" class="btn btn-secondary">Back</button>
            </div>
            
            <div style="max-width: 600px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 1.1rem;">Grid Size</label>
                    <select id="gridSizeSelect" onchange="updateGridSize()" class="input">
                        <option value="2">2 cards per row</option>
                        <option value="3">3 cards per row</option>
                        <option value="4">4 cards per row</option>
                        <option value="5">5 cards per row</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button onclick="showExportModal()" class="btn btn-primary" style="width: 100%;">
                        üì• Export Data
                    </button>
                </div>
                
                <div class="form-group">
                    <h3 style="margin-bottom: 1rem;">Account Info</h3>
                    <p style="color: #9CA3AF; margin-bottom: 0.5rem;">Name: <span id="accountName"></span></p>
                    <p style="color: #9CA3AF;">Created: <span id="accountCreated"></span></p>
                </div>
            </div>
        </div>

        <!-- Collection Screen -->
        <div id="collectionScreen" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 id="collectionTitle" style="color: rgb(0, 128, 255); font-size: 2rem; font-weight: bold;">Collection</h1>
                <div class="flex gap-4">
                    <button onclick="showCardForm()" class="btn btn-primary">+ Add Card</button>
                    <button onclick="showMenu()" class="btn btn-secondary">Back</button>
                </div>
            </div>
            
            <div id="cardsGrid" class="grid grid-3"></div>
            
            <div id="emptyState" class="text-center mt-8 hidden">
                <p style="color: #9CA3AF; font-size: 1.2rem;">No cards yet. Add your first card!</p>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1rem;">Export Data</h2>
            <p style="color: #9CA3AF; margin-bottom: 1rem;">Choose how to export your data:</p>
            
            <div class="flex gap-4 mb-4">
                <button onclick="saveAsFile()" class="btn btn-primary" style="flex: 1;">Save to File</button>
                <button onclick="tryDownload()" class="btn btn-secondary" style="flex: 1;">Auto Download</button>
            </div>
            
            <div class="flex gap-4 mb-4">
                <button onclick="showExportText()" class="btn btn-secondary" style="width: 100%;">Show as Text</button>
            </div>
            
            <div id="exportTextContainer" class="hidden">
                <p style="color: #9CA3AF; margin-bottom: 0.5rem;">Copy this text and save it as a .json file:</p>
                <div id="exportText" class="export-text"></div>
                <button onclick="copyExportText()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Copy to Clipboard</button>
            </div>
            
            <div class="flex gap-4 mt-4">
                <button onclick="hideExportModal()" class="btn btn-secondary" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1rem;">Confirm Delete</h2>
            <p style="margin-bottom: 2rem; color: #9CA3AF;">Are you sure you want to delete this card? This action cannot be undone.</p>
            <div class="flex gap-4">
                <button onclick="confirmDelete()" class="btn btn-danger" style="flex: 1;">Delete</button>
                <button onclick="cancelDelete()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Card Form Modal -->
    <div id="cardModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="cardModalTitle" style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1.5rem;">Add Card</h2>
            
            <div class="form-row">
                <input type="text" id="cardName" placeholder="Card Name" class="input">
                <input type="text" id="cardSet" placeholder="Set" class="input">
            </div>
            
            <div class="form-row">
                <input type="text" id="cardNumber" placeholder="Card Number" class="input">
                <input type="text" id="cardRarity" placeholder="Rarity" class="input">
            </div>
            
            <div class="form-row">
                <input type="text" id="cardCondition" placeholder="Condition" class="input">
                <input type="url" id="cardImage" placeholder="Image URL" class="input">
            </div>
            
            <div class="flex gap-4 mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="cardIsGraded" onchange="toggleGradeInput()" style="margin-right: 0.5rem;">
                    Graded Card
                </label>
                <input type="text" id="cardGrade" placeholder="Grade (e.g., PSA 10)" class="input hidden" style="flex: 1;">
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 style="font-size: 1.1rem; font-weight: bold;">Price History</h3>
                    <button onclick="addPrice()" class="btn btn-primary">+ Add Price</button>
                </div>
                <div id="pricesContainer"></div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="saveCard()" class="btn btn-primary" style="flex: 1;">Save Card</button>
                <button onclick="hideCardForm()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            currentScreen: 'login',
            accounts: [],
            currentAccount: null,
            gridSize: 3,
            showcaseCards: [],
            huntlistCards: [],
            currentCollection: 'showcase',
            editingCard: null,
            cardPrices: [],
            cardToDelete: null
        };

        // Initialize app
        function init() {
            loadData();
            if (appState.currentAccount) {
                showMenu();
            }
        }

        // Data persistence - using in-memory storage instead of localStorage for compatibility
        function saveData() {
            const data = {
                accounts: appState.accounts,
                showcaseCards: appState.showcaseCards,
                huntlistCards: appState.huntlistCards,
                gridSize: appState.gridSize
            };
            try {
                localStorage.setItem('cardsArchivesData', JSON.stringify(data));
            } catch (error) {
                console.log('LocalStorage not available, using memory storage');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('cardsArchivesData');
                if (saved) {
                    const data = JSON.parse(saved);
                    appState.accounts = data.accounts || [];
                    appState.showcaseCards = data.showcaseCards || [];
                    appState.huntlistCards = data.huntlistCards || [];
                    appState.gridSize = data.gridSize || 3;
                }
            } catch (error) {
                console.log('Error loading data:', error);
            }
        }

        // Screen management
        function showScreen(screenId) {
            const screens = ['loginScreen', 'menuScreen', 'settingsScreen', 'collectionScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            appState.currentScreen = screenId;
        }

        // Authentication
        function login() {
            const accountName = document.getElementById('loginAccountName').value.trim();
            const pin = document.getElementById('loginPin').value;
            
            if (!accountName || !pin) {
                showCustomAlert('Please enter both account name and PIN');
                return;
            }
            
            const account = appState.accounts.find(acc => 
                acc.name === accountName && acc.pin === pin
            );
            
            if (account) {
                appState.currentAccount = account;
                showMenu();
                clearLoginForm();
            } else {
                showCustomAlert('Invalid account name or PIN');
            }
        }

        function logout() {
            appState.currentAccount = null;
            showScreen('loginScreen');
            clearLoginForm();
        }

        function clearLoginForm() {
            document.getElementById('loginAccountName').value = '';
            document.getElementById('loginPin').value = '';
        }

        function showCreateForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('createForm').classList.remove('hidden');
        }

        function hideCreateForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('createAccountName').value = '';
            document.getElementById('createPin').value = '';
        }

        function createAccount() {
            const accountName = document.getElementById('createAccountName').value.trim();
            const pin = document.getElementById('createPin').value;
            
            if (!accountName) {
                showCustomAlert('Please enter a valid account name');
                return;
            }
            
            if (pin.length !== 6) {
                showCustomAlert('Please enter a 6-digit PIN');
                return;
            }
            
            // Check if account name already exists
            if (appState.accounts.find(acc => acc.name === accountName)) {
                showCustomAlert('Account name already exists');
                return;
            }
            
            const newAccount = {
                id: Date.now(),
                name: accountName,
                pin: pin,
                createdAt: new Date().toISOString()
            };
            
            appState.accounts.push(newAccount);
            appState.currentAccount = newAccount;
            saveData();
            hideCreateForm();
            showMenu();
        }

        // Navigation
        function showMenu() {
            showScreen('menuScreen');
            if (appState.currentAccount) {
                document.getElementById('currentUserName').textContent = appState.currentAccount.name;
            }
        }

        function showSettings() {
            showScreen('settingsScreen');
            document.getElementById('gridSizeSelect').value = appState.gridSize;
            document.getElementById('accountName').textContent = appState.currentAccount?.name || '';
            document.getElementById('accountCreated').textContent = 
                appState.currentAccount ? new Date(appState.currentAccount.createdAt).toLocaleDateString() : '';
        }

        function showShowcase() {
            appState.currentCollection = 'showcase';
            showCollection();
        }

        function showHuntlist() {
            appState.currentCollection = 'huntlist';
            showCollection();
        }

        function showCollection() {
            showScreen('collectionScreen');
            document.getElementById('collectionTitle').textContent = 
                appState.currentCollection === 'showcase' ? 'Showcase' : 'Hunt List';
            renderCards();
        }

        function updateGridSize() {
            appState.gridSize = parseInt(document.getElementById('gridSizeSelect').value);
            saveData();
            renderCards();
        }

        // Card management
        function getCurrentCards() {
            const cards = appState.currentCollection === 'showcase' ? 
                appState.showcaseCards : appState.huntlistCards;
            return cards.filter(card => card.accountId === appState.currentAccount?.id);
        }

        function renderCards() {
            const cardsGrid = document.getElementById('cardsGrid');
            const emptyState = document.getElementById('emptyState');
            const cards = getCurrentCards();
            
            cardsGrid.className = `grid grid-${appState.gridSize}`;
            
            if (cards.length === 0) {
                cardsGrid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            cardsGrid.innerHTML = cards.map(card => `
                <div class="card">
                    ${card.image ? `<img src="${card.image}" alt="${card.name}" class="card-image">` : ''}
                    <div class="card-title">${card.name}</div>
                    <div class="card-info">${card.set} #${card.number}</div>
                    <div class="card-info">${card.rarity} - ${card.condition}</div>
                    ${card.isGraded ? `<div style="color: #FCD34D; font-size: 0.9rem; margin-bottom: 0.5rem;">Graded: ${card.grade}</div>` : ''}
                    ${renderPriceChart(card)}
                    <div class="flex gap-4" style="margin-top: 1rem;">
                        <button onclick="editCard(${card.id})" class="icon-btn btn-primary">‚úèÔ∏è</button>
                        <button onclick="deleteCard(${card.id})" class="icon-btn btn-danger">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderPriceChart(card) {
            if (!card.prices || card.prices.length === 0) return '';
            
            const latestPrice = card.prices[card.prices.length - 1]?.price || 0;
            return `
                <div style="margin-top: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">Price History</div>
                    <div class="chart-container">
                        <canvas id="chart-${card.id}" width="100" height="50"></canvas>
                    </div>
                    <div style="color: #10B981; font-size: 0.9rem;">Current: $${latestPrice}</div>
                </div>
            `;
        }

        function showCardForm() {
            appState.editingCard = null;
            appState.cardPrices = [];
            clearCardForm();
            document.getElementById('cardModalTitle').textContent = 'Add Card';
            document.getElementById('cardModal').classList.remove('hidden');
        }

        function hideCardForm() {
            document.getElementById('cardModal').classList.add('hidden');
            clearCardForm();
        }

        function clearCardForm() {
            document.getElementById('cardName').value = '';
            document.getElementById('cardSet').value = '';
            document.getElementById('cardNumber').value = '';
            document.getElementById('cardRarity').value = '';
            document.getElementById('cardCondition').value = '';
            document.getElementById('cardImage').value = '';
            document.getElementById('cardIsGraded').checked = false;
            document.getElementById('cardGrade').value = '';
            document.getElementById('cardGrade').classList.add('hidden');
            document.getElementById('pricesContainer').innerHTML = '';
            appState.cardPrices = [];
        }

        function toggleGradeInput() {
            const isGraded = document.getElementById('cardIsGraded').checked;
            const gradeInput = document.getElementById('cardGrade');
            
            if (isGraded) {
                gradeInput.classList.remove('hidden');
            } else {
                gradeInput.classList.add('hidden');
                gradeInput.value = '';
            }
        }

        function addPrice() {
            const price = {
                date: new Date().toISOString().split('T')[0],
                price: 0
            };
            appState.cardPrices.push(price);
            renderPrices();
        }

        function renderPrices() {
            const container = document.getElementById('pricesContainer');
            container.innerHTML = appState.cardPrices.map((price, index) => `
                <div class="price-entry">
                    <input type="date" value="${price.date}" onchange="updatePrice(${index}, 'date', this.value)">
                    <input type="number" placeholder="Price" value="${price.price}" onchange="updatePrice(${index}, 'price', parseFloat(this.value) || 0)">
                    <button onclick="removePrice(${index})" class="icon-btn btn-danger">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updatePrice(index, field, value) {
            appState.cardPrices[index][field] = value;
        }

        function removePrice(index) {
            appState.cardPrices.splice(index, 1);
            renderPrices();
        }

        function saveCard() {
            const cardData = {
                name: document.getElementById('cardName').value.trim(),
                set: document.getElementById('cardSet').value.trim(),
                number: document.getElementById('cardNumber').value.trim(),
                rarity: document.getElementById('cardRarity').value.trim(),
                condition: document.getElementById('cardCondition').value.trim(),
                image: document.getElementById('cardImage').value.trim(),
                isGraded: document.getElementById('cardIsGraded').checked,
                grade: document.getElementById('cardGrade').value.trim(),
                prices: [...appState.cardPrices]
            };

            if (!cardData.name) {
                showCustomAlert('Please enter a card name');
                return;
            }

            if (appState.editingCard) {
                // Update existing card
                const cards = appState.currentCollection === 'showcase' ? 
                    appState.showcaseCards : appState.huntlistCards;
                const index = cards.findIndex(card => card.id === appState.editingCard.id);
                if (index !== -1) {
                    cards[index] = { ...appState.editingCard, ...cardData };
                }
            } else {
                // Add new card
                const newCard = {
                    id: Date.now(),
                    accountId: appState.currentAccount?.id,
                    ...cardData,
                    createdAt: new Date().toISOString()
                };

                if (appState.currentCollection === 'showcase') {
                    appState.showcaseCards.push(newCard);
                } else {
                    appState.huntlistCards.push(newCard);
                }
            }

            saveData();
            hideCardForm();
            renderCards();
        }

        function editCard(cardId) {
            const cards = appState.currentCollection === 'showcase' ? 
                appState.showcaseCards : appState.huntlistCards;
            const card = cards.find(c => c.id === cardId);
            
            if (card) {
                appState.editingCard = card;
                appState.cardPrices = [...(card.prices || [])];
                
                document.getElementById('cardName').value = card.name || '';
                document.getElementById('cardSet').value = card.set || '';
                document.getElementById('cardNumber').value = card.number || '';
                document.getElementById('cardRarity').value = card.rarity || '';
                document.getElementById('cardCondition').value = card.condition || '';
                document.getElementById('cardImage').value = card.image || '';
                document.getElementById('cardIsGraded').checked = card.isGraded || false;
                document.getElementById('cardGrade').value = card.grade || '';
                
                toggleGradeInput();
                renderPrices();
                
                document.getElementById('cardModalTitle').textContent = 'Edit Card';
                document.getElementById('cardModal').classList.remove('hidden');
            }
        }

        function deleteCard(cardId) {
            appState.cardToDelete = cardId;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function confirmDelete() {
            if (appState.cardToDelete) {
                if (appState.currentCollection === 'showcase') {
                    appState.showcaseCards = appState.showcaseCards.filter(card => card.id !== appState.cardToDelete);
                } else {
                    appState.huntlistCards = appState.huntlistCards.filter(card => card.id !== appState.cardToDelete);
                }
                saveData();
                renderCards();
            }
            cancelDelete();
        }

        function cancelDelete() {
            appState.cardToDelete = null;
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // Export functionality with mobile-friendly options
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
            document.getElementById('exportTextContainer').classList.add('hidden');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
            document.getElementById('exportTextContainer').classList.add('hidden');
        }

        function getExportData() {
            return {
                account: appState.currentAccount,
                showcaseCards: appState.showcaseCards.filter(card => card.accountId === appState.currentAccount?.id),
                huntlistCards: appState.huntlistCards.filter(card => card.accountId === appState.currentAccount?.id),
                exportDate: new Date().toISOString()
            };
        }

        function tryDownload() {
            const exportData = getExportData();
            const dataStr = JSON.stringify(exportData, null, 2);
            
            try {
                // Try standard download method first
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `cards-archive-${appState.currentAccount?.name}-${new Date().toISOString().split('T')[0]}.json`;
                
                // Try to trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showCustomAlert('Download started! Check your downloads folder.');
                hideExportModal();
            } catch (error) {
                console.log('Download failed, showing alternative options:', error);
                showExportText();
            }
        }

        // New function to trigger file save dialog
        function saveAsFile() {
            const exportData = getExportData();
            const dataStr = JSON.stringify(exportData, null, 2);
            const fileName = `cards-archive-${appState.currentAccount?.name}-${new Date().toISOString().split('T')[0]}.json`;
            
            // Check if the File System Access API is supported
            if ('showSaveFilePicker' in window) {
                try {
                    window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    }).then(async (fileHandle) => {
                        const writable = await fileHandle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                        showCustomAlert('File saved successfully!');
                        hideExportModal();
                    }).catch((error) => {
                        if (error.name !== 'AbortError') {
                            console.log('Save dialog cancelled or failed:', error);
                            showExportText();
                        }
                    });
                } catch (error) {
                    console.log('File System Access API failed:', error);
                    tryDownload();
                }
            } else {
                // Fallback to standard download
                tryDownload();
            }
        }

        function showExportText() {
            const exportData = getExportData();
            const dataStr = JSON.stringify(exportData, null, 2);
            
            document.getElementById('exportText').textContent = dataStr;
            document.getElementById('exportTextContainer').classList.remove('hidden');
        }

        function copyExportText() {
            const exportText = document.getElementById('exportText');
            
            try {
                // Try modern clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(exportText.textContent).then(() => {
                        showCustomAlert('Data copied to clipboard! You can now paste it into a text file and save as .json');
                    }).catch(() => {
                        fallbackCopyText(exportText.textContent);
                    });
                } else {
                    fallbackCopyText(exportText.textContent);
                }
            } catch (error) {
                fallbackCopyText(exportText.textContent);
            }
        }

        function fallbackCopyText(text) {
            try {
                // Fallback method for older browsers/environments
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showCustomAlert('Data copied to clipboard! You can now paste it into a text file and save as .json');
                } else {
                    showCustomAlert('Copy failed. Please manually select and copy the text above.');
                }
            } catch (error) {
                showCustomAlert('Copy not supported. Please manually select and copy the text above, then save it as a .json file.');
            }
        }

        // Data import
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        let importCount = 0;
                        
                        if (importedData.showcaseCards && Array.isArray(importedData.showcaseCards)) {
                            // Update account IDs to current account
                            const updatedShowcaseCards = importedData.showcaseCards.map(card => ({
                                ...card,
                                id: Date.now() + Math.random(), // New unique ID
                                accountId: appState.currentAccount?.id || card.accountId
                            }));
                            appState.showcaseCards = [...appState.showcaseCards, ...updatedShowcaseCards];
                            importCount += updatedShowcaseCards.length;
                        }
                        
                        if (importedData.huntlistCards && Array.isArray(importedData.huntlistCards)) {
                            // Update account IDs to current account
                            const updatedHuntlistCards = importedData.huntlistCards.map(card => ({
                                ...card,
                                id: Date.now() + Math.random(), // New unique ID
                                accountId: appState.currentAccount?.id || card.accountId
                            }));
                            appState.huntlistCards = [...appState.huntlistCards, ...updatedHuntlistCards];
                            importCount += updatedHuntlistCards.length;
                        }
                        
                        saveData();
                        showCustomAlert(`Successfully imported ${importCount} cards!`);
                        
                        // Clear the file input
                        document.getElementById('importFile').value = '';
                        
                    } catch (error) {
                        showCustomAlert('Error importing data: Invalid file format. Please ensure it\'s a valid JSON file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Custom alert system
        function showCustomAlert(message) {
            // Create a temporary alert modal
            const alertModal = document.createElement('div');
            alertModal.className = 'modal';
            alertModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <h2 style="color: rgb(0, 128, 255); font-size: 1.5rem; margin-bottom: 1rem;">Notice</h2>
                    <p style="margin-bottom: 2rem; color: #9CA3AF;">${message}</p>
                    <button onclick="this.closest('.modal').remove()" class="btn btn-primary" style="width: 100%;">OK</button>
                </div>
            `;
            document.body.appendChild(alertModal);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (alertModal.parentNode) {
                    alertModal.remove();
                }
            }, 10000);
        }
		function checkInsiderAccess() {
    const pin = document.getElementById('insiderPin').value.trim();

    // G√©n√®re la date du jour depuis l'appareil
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');

    // Code attendu = AAAAMMJJ (8 chiffres)
    const correctCode = `${yyyy}${mm}${dd}`;

    if (pin === correctCode) {
        window.location.href = "https://cardsarchives.github.io/Cards-Archives-Insider"; // ta page sp√©ciale
    } else {
        showCustomAlert("Invalid Insider PIN");
    }
}

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
